WITH financial_leverage_filter AS(
    WITH financial_leverage_ratios AS(
        SELECT
            us_companies.company_id,
            us_companies.ticker,
            Company_Name,
            total_liabilities,
            total_equity,
            total_assets,
            ROUND(total_liabilities / NULLIF(total_equity, 0), 2) AS debt_to_equity,
            ROUND(total_liabilities / NULLIF(total_assets, 0), 2) AS debt_to_total_assets
        FROM 
            us_companies
        LEFT JOIN balance_sheet ON us_companies.company_id = balance_sheet.company_id
        WHERE
            (industry_id BETWEEN 101000 AND 101006) AND
            fiscal_year = 2022 AND
            fiscal_period = 'Q2'
    )
    SELECT *
    FROM
        financial_leverage_ratios
    WHERE
        (debt_to_equity BETWEEN 0 AND (SELECT AVG(debt_to_equity) FROM financial_leverage_ratios)) AND
        (debt_to_total_assets BETWEEN 0 AND (SELECT AVG(debt_to_total_assets) FROM financial_leverage_ratios)) 
),
interest_coverage_filter AS(
    WITH income_statement_ratio AS(
        SELECT
            us_companies.company_id,
            us_companies.ticker,
            company_name,
            operating_income,
            interest_expense_net,
            ROUND(operating_income / NULLIF(interest_expense_net, 0), 2) AS interest_coverage
        FROM
            us_companies
        LEFT JOIN income_statement ON us_companies.company_id = income_statement.company_id
        WHERE
            (industry_id BETWEEN 101000 AND 101006) AND
            fiscal_year = 2022 AND
            fiscal_period = 'Q2'
    )
    SELECT *
    FROM
        income_statement_ratio
    WHERE
        interest_coverage > (SELECT AVG(interest_coverage) FROM income_statement_ratio)
)

SELECT
    financial_leverage_filter.company_id,
    financial_leverage_filter.ticker,
    financial_leverage_filter.company_name,
    debt_to_equity,
    debt_to_total_assets,
    interest_coverage
FROM
    financial_leverage_filter
INNER JOIN interest_coverage_filter ON financial_leverage_filter.company_id = interest_coverage_filter.company_id;
